<% token = @form&.dig(:token) || params[:token] || @temp_upload&.token %>

<%= render "shared/scheduling_banner" %>

<div class="max-w-3xl mx-auto bg-white/5 rounded-xl p-6 border border-white/10">
  <h2 class="text-xl font-semibold mb-4">Configure campaign</h2>

  <% if (@errors || []).any? %>
    <div class="mb-4 p-3 rounded bg-red-500/15 text-red-200">
      <ul class="list-disc pl-5">
        <% @errors.each do |e| %><li><%= e %></li><% end %>
      </ul>
    </div>
  <% end %>

  <%# ---------- MAIN FINALIZE FORM (POST) ---------- %>
  <%= form_tag finalize_admin_campaign_wizard_path, method: :post, data: { turbo: false }, class: "space-y-6" do %>
    <%= hidden_field_tag "campaign[token]", token %>

    <div>
      <label class="block mb-1 text-sm text-white/80">Subject</label>
      <%= text_field_tag "campaign[subject]",
                         @form&.dig(:subject),
                         required: true,
                         class: "w-full bg-white/10 border border-white/10 rounded px-3 py-2 text-white placeholder-white/40" %>
    </div>

    <div>
      <label class="block mb-1 text-sm text-white/80">Preview text (optional)</label>
      <%= text_field_tag "campaign[preview_text]",
                         @form&.dig(:preview_text),
                         class: "w-full bg-white/10 border border-white/10 rounded px-3 py-2 text-white placeholder-white/40" %>
    </div>

    <div>
      <label class="block mb-1 text-sm text-white/80">Template</label>
      <% options = @templates.map { |t| [t[:name], t[:slug]] } %>
      <%= select_tag :template_slug,
                     options_for_select(options, @template_slug),
                     include_blank: @templates.blank? ? "No templates found" : "Select a template",
                     class: "w-full bg-white/5 text-white/90 rounded px-3 py-2" %>
    </div>

    <div class="flex items-center gap-3">
      <label class="inline-flex items-center gap-2">
        <%= check_box_tag "campaign[send_now]", "1", @form&.dig(:send_now) %>
        <span>Send now</span>
      </label>
    </div>

    <%# ----- Schedule (UK time) with native datetime picker ----- %>
    <% default_local =
         (@form&.dig(:scheduled_at_local).presence) ||
           Time.use_zone('London') { Time.zone.now.advance(minutes: 15).strftime('%Y-%m-%dT%H:%M') } %>

    <div>
      <label class="block mb-1 text-sm text-white/80">Schedule (UK time)</label>
      <%= datetime_field_tag "campaign[scheduled_at_local]",
                             default_local,
                             id:    "campaign_scheduled_at_local",
                             min:   Time.use_zone('London') { Time.zone.now.strftime('%Y-%m-%dT%H:%M') },
                             step:  60,  # 60s increments; adjust if you want finer control
                             class: "w-full bg-white/10 border border-white/10 rounded px-3 py-2 text-white placeholder-white/40" %>
      <p class="text-xs text-white/50 mt-1">Leave blank if “Send now” is ticked.</p>
    </div>

    <div class="pt-3 flex items-center gap-3">
      <%= link_to "Back",
                  preview_admin_campaign_wizard_path(token: token),
                  class: "px-3 py-2 rounded bg-white/10 hover:bg-white/15" %>

      <%= submit_tag "Finalize",
                     class: "px-3 py-2 rounded bg-brand-green/20 hover:bg-brand-green/30" %>
    </div>
  <% end %>

  <%# ---------- SEPARATE CANCEL ACTION (DELETE) — NOT NESTED ---------- %>
  <div class="mt-4">
    <%= link_to "Cancel and discard",
                cancel_admin_campaign_wizard_path,
                data: { turbo_method: :delete, turbo_confirm: "Cancel and discard uploaded contacts?" },
                class: "px-3 py-2 inline-block rounded bg-white/10 hover:bg-white/20" %>
  </div>
</div>


<script>
    (function () {
        var sendNow = document.querySelector('input[name="campaign[send_now]"]');
        var sched   = document.getElementById('campaign_scheduled_at_local');
        if (!sendNow || !sched) return;

        function sync() {
            var on = sendNow.checked;
            sched.disabled = on;
            sched.classList.toggle('opacity-50', on);
        }

        sendNow.addEventListener('change', sync);
        // run once on load
        sync();
    })();
</script>