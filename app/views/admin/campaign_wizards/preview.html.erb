<!-- app/views/admin/campaign_wizards/preview.html.erb -->
<%= render "shared/scheduling_banner" %>

<div class="max-w-5xl mx-auto">
  <h1 class="text-2xl font-semibold mb-2">Preview contacts</h1>

  <div class="mb-4 flex items-center gap-3">
    <span class="inline-flex items-center px-2 py-1 rounded bg-emerald-500/15 text-emerald-200 text-sm">
  Imported <strong class="mx-1"><%= @recipients.size %></strong> valid email<%= 's' unless @recipients.size == 1 %>
</span>

    <% if Array(@invalids).any? %>
      <details id="invalids-details" class="ml-2">
        <summary class="cursor-pointer inline-flex items-center px-2 py-1 rounded bg-red-500/15 text-red-200 text-sm">
          <strong class="mx-1"><%= Array(@invalids).size %></strong> invalid not imported — click to view
        </summary>
        <div class="mt-2 max-h-48 overflow-auto rounded border border-white/10">
          <table class="w-full text-sm">
            <thead class="bg-white/5 text-white/70">
            <tr>
              <th class="text-left px-3 py-2">CSV row</th>
              <th class="text-left px-3 py-2">Email</th>
              <th class="text-left px-3 py-2">Reason</th>
            </tr>
            </thead>
            <tbody>
            <% Array(@invalids).each do |inv| %>
              <tr class="border-t border-white/10">
                <td class="px-3 py-1.5"><%= inv[:row] %></td>
                <td class="px-3 py-1.5 font-mono"><%= inv[:email] %></td>
                <td class="px-3 py-1.5">Invalid or blank email</td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      </details>
    <% end %>
  </div>

  <!-- Existing preview of valid rows -->
  <div class="rounded border border-white/10 overflow-hidden">
    <table class="w-full text-sm">
      <thead class="bg-white/5 text-white/70">
      <tr>
        <th class="text-left px-3 py-2">Email</th>
        <% if (first = @recipients.first) %>
          <% first.fields.keys.each do |k| %>
            <th class="text-left px-3 py-2"><%= k %></th>
          <% end %>
        <% end %>
      </tr>
      </thead>
      <tbody>
      <% @recipients.each do |r| %>
        <tr class="border-t border-white/10">
          <td class="px-3 py-1.5 font-mono"><%= r.email %></td>
          <% (first&.fields || {}).keys.each do |k| %>
            <td class="px-3 py-1.5"><%= r.fields[k] %></td>
          <% end %>
        </tr>
      <% end %>
      </tbody>
    </table>
  </div>

  <div class="mt-6 flex justify-end gap-3">
    <%= button_to "Cancel", cancel_admin_campaign_wizard_path(token: @temp_upload.token),
                  method: :delete,
                  class: "px-4 py-2 rounded-lg bg-[#121212] text-white border border-white font-medium" %>

    <%= form_with url: configure_admin_campaign_wizard_path(token: @temp_upload.token),
                  method: :post,
                  data: { turbo: false },
                  html: { id: "wizard-continue-form" } do %>
      <%= submit_tag "Continue",
                     id: "wizard-continue-btn",
                     class: "px-4 py-2 rounded-lg bg-[#A49EF2] text-white font-medium hover:bg-[#928AEF] transition" %>
    <% end %>
  </div>

  <!-- Loading overlay (hidden by default) -->
  <div id="wizard-loading"
       class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/80">
    <div class="flex flex-col items-center gap-4 text-white">
      <!-- spinner -->
      <div class="h-8 w-8 rounded-full border-2 border-white/30 border-t-white animate-spin"></div>
      <div class="text-sm text-white/80">Loading email templates from Mailchimp…</div>
    </div>
  </div>
</div>

<script>
    (function () {
        var form = document.getElementById('wizard-continue-form');
        if (!form) return;

        var btn  = document.getElementById('wizard-continue-btn');
        var mask = document.getElementById('wizard-loading');

        var show = function(el){ el.classList.remove('hidden'); el.classList.add('flex'); };
        var hide = function(el){ el.classList.add('hidden'); el.classList.remove('flex'); };

        form.addEventListener('submit', function (e) {
            // guard against double clicks
            if (btn) {
                btn.disabled = true;
                btn.classList.add('opacity-60', 'cursor-not-allowed');
                btn.textContent = 'Loading…';
            }
            if (mask) show(mask);
            // Let the request proceed (no Turbo; full POST + redirect)
        });

        // Safety: if the page is restored from bfcache, reset UI
        window.addEventListener('pageshow', function() {
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('opacity-60', 'cursor-not-allowed');
                btn.textContent = 'Continue';
            }
            if (mask) hide(mask);
        });
    })();
</script>

<% if Array(@invalids).any? %>
  <script>
      (function() {
          var d = document.getElementById('invalids-details');
          if (!d) return;
          // open it and scroll into view once the DOM is ready
          requestAnimationFrame(function() {
              d.setAttribute('open', 'open');
              d.scrollIntoView({ behavior: 'smooth', block: 'center' });
          });
      })();
  </script>
<% end %>